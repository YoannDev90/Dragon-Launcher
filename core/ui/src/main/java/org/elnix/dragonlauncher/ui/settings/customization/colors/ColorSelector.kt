package org.elnix.dragonlauncher.ui.settings.customization.colors


import androidx.compose.animation.core.Ease
import androidx.compose.animation.core.animateIntAsState
import androidx.compose.animation.core.tween
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.ColumnScope
import androidx.compose.foundation.layout.IntrinsicSize
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxHeight
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.lazy.LazyListScope
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.MoreVert
import androidx.compose.material.icons.filled.Restore
import androidx.compose.material.icons.filled.SelectAll
import androidx.compose.material.icons.filled.Shuffle
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Button
import androidx.compose.material3.DropdownMenu
import androidx.compose.material3.HorizontalDivider
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import kotlinx.coroutines.launch
import org.elnix.dragonlauncher.common.R
import org.elnix.dragonlauncher.common.utils.colors.adjustBrightness
import org.elnix.dragonlauncher.enumsui.CustomColorModeEditing
import org.elnix.dragonlauncher.enumsui.DefaultThemes
import org.elnix.dragonlauncher.enumsui.DefaultThemes.AMOLED
import org.elnix.dragonlauncher.enumsui.DefaultThemes.CUSTOM
import org.elnix.dragonlauncher.enumsui.DefaultThemes.DARK
import org.elnix.dragonlauncher.enumsui.DefaultThemes.LIGHT
import org.elnix.dragonlauncher.enumsui.DefaultThemes.SYSTEM
import org.elnix.dragonlauncher.enumsui.customColorModeEditingIcon
import org.elnix.dragonlauncher.enumsui.customColorModeEditingName
import org.elnix.dragonlauncher.enumsui.defaultThemeName
import org.elnix.dragonlauncher.settings.bases.BaseSettingObject
import org.elnix.dragonlauncher.settings.stores.ColorModesSettingsStore
import org.elnix.dragonlauncher.settings.stores.ColorSettingsStore
import org.elnix.dragonlauncher.ui.UiConstants.DragonShape
import org.elnix.dragonlauncher.ui.colors.AppObjectsColors
import org.elnix.dragonlauncher.ui.colors.ColorPickerRow
import org.elnix.dragonlauncher.ui.components.burger.BurgerAction
import org.elnix.dragonlauncher.ui.components.burger.BurgerListAction
import org.elnix.dragonlauncher.ui.components.generic.ActionRow
import org.elnix.dragonlauncher.ui.components.settings.SettingsColorPicker
import org.elnix.dragonlauncher.ui.components.settings.SettingsSwitchRow
import org.elnix.dragonlauncher.ui.components.settings.asState
import org.elnix.dragonlauncher.ui.components.settings.asStateNull
import org.elnix.dragonlauncher.ui.dialogs.UserValidation
import org.elnix.dragonlauncher.ui.helpers.SwitchRow
import org.elnix.dragonlauncher.ui.helpers.settings.SettingsLazyHeader
import org.elnix.dragonlauncher.ui.modifiers.conditional
import org.elnix.dragonlauncher.ui.theme.LocalExtraColors
import org.elnix.dragonlauncher.ui.theme.getSystemColorScheme

@Suppress("AssignedValueIsNeverRead")
@Composable
fun ColorSelectorTab(
    onBack: (() -> Unit)
) {
    val ctx = LocalContext.current
    val scope = rememberCoroutineScope()

    val dynamicColors by ColorModesSettingsStore.dynamicColor.asState()
    val defaultTheme by ColorModesSettingsStore.defaultTheme.asState()

    val defaultColorScheme = getSystemColorScheme(defaultTheme, dynamicColors)

    // ───────────── PRIMARY COLORS ─────────────
    val primaryColors = listOf(
        ColorEdit(ColorSettingsStore.primaryColor, stringResource(R.string.primary_color), defaultColorScheme.primary),
        ColorEdit(ColorSettingsStore.onPrimaryColor, stringResource(R.string.on_primary_color), defaultColorScheme.onPrimary),
        ColorEdit(ColorSettingsStore.primaryContainerColor, stringResource(R.string.primary_container_color), defaultColorScheme.primaryContainer),
        ColorEdit(ColorSettingsStore.onPrimaryContainerColor, stringResource(R.string.on_primary_container_color), defaultColorScheme.onPrimaryContainer),
        ColorEdit(ColorSettingsStore.inversePrimaryColor, stringResource(R.string.inverse_primary_color), defaultColorScheme.inversePrimary)
    )
    val primarySectionTitle = stringResource(R.string.primary_colors_section)

    // ───────────── SECONDARY COLORS ─────────────
    val secondaryColors = listOf(
        ColorEdit(ColorSettingsStore.secondaryColor, stringResource(R.string.secondary_color), defaultColorScheme.secondary),
        ColorEdit(ColorSettingsStore.onSecondaryColor, stringResource(R.string.on_secondary_color), defaultColorScheme.onSecondary),
        ColorEdit(ColorSettingsStore.secondaryContainerColor, stringResource(R.string.secondary_container_color), defaultColorScheme.secondaryContainer),
        ColorEdit(ColorSettingsStore.onSecondaryContainerColor, stringResource(R.string.on_secondary_container_color), defaultColorScheme.onSecondaryContainer)
    )
    val secondarySectionTitle = stringResource(R.string.secondary_colors_section)

    // ───────────── TERTIARY COLORS ─────────────
    val tertiaryColors = listOf(
        ColorEdit(ColorSettingsStore.tertiaryColor, stringResource(R.string.tertiary_color), defaultColorScheme.tertiary),
        ColorEdit(ColorSettingsStore.onTertiaryColor, stringResource(R.string.on_tertiary_color), defaultColorScheme.onTertiary),
        ColorEdit(ColorSettingsStore.tertiaryContainerColor, stringResource(R.string.tertiary_container_color), defaultColorScheme.tertiaryContainer),
        ColorEdit(ColorSettingsStore.onTertiaryContainerColor, stringResource(R.string.on_tertiary_container_color), defaultColorScheme.onTertiaryContainer)
    )
    val tertiarySectionTitle = stringResource(R.string.tertiary_colors_section)

    // ───────────── BACKGROUND / SURFACE ─────────────
    val backgroundColors = listOf(
        ColorEdit(ColorSettingsStore.backgroundColor, stringResource(R.string.background_color), defaultColorScheme.background),
        ColorEdit(ColorSettingsStore.onBackgroundColor, stringResource(R.string.on_background_color), defaultColorScheme.onBackground),
        ColorEdit(ColorSettingsStore.surfaceColor, stringResource(R.string.surface_color), defaultColorScheme.surface),
        ColorEdit(ColorSettingsStore.onSurfaceColor, stringResource(R.string.on_surface_color), defaultColorScheme.onSurface),
        ColorEdit(ColorSettingsStore.surfaceVariantColor, stringResource(R.string.surface_variant_color), defaultColorScheme.surfaceVariant),
        ColorEdit(ColorSettingsStore.onSurfaceVariantColor, stringResource(R.string.on_surface_variant_color), defaultColorScheme.onSurfaceVariant),
        ColorEdit(ColorSettingsStore.surfaceTintColor, stringResource(R.string.surface_tint_color), defaultColorScheme.surfaceTint),
        ColorEdit(ColorSettingsStore.inverseSurfaceColor, stringResource(R.string.inverse_surface_color), defaultColorScheme.inverseSurface),
        ColorEdit(ColorSettingsStore.inverseOnSurfaceColor, stringResource(R.string.inverse_on_surface_color), defaultColorScheme.inverseOnSurface)
    )
    val backgroundSectionTitle = stringResource(R.string.background_surface_colors_section)

    // ───────────── ERROR COLORS ─────────────
    val errorColors = listOf(
        ColorEdit(ColorSettingsStore.errorColor, stringResource(R.string.error_color), defaultColorScheme.error),
        ColorEdit(ColorSettingsStore.onErrorColor, stringResource(R.string.on_error_color), defaultColorScheme.onError),
        ColorEdit(ColorSettingsStore.errorContainerColor, stringResource(R.string.error_container_color), defaultColorScheme.errorContainer),
        ColorEdit(ColorSettingsStore.onErrorContainerColor, stringResource(R.string.on_error_container_color), defaultColorScheme.onErrorContainer)
    )
    val errorSectionTitle = stringResource(R.string.error_colors_section)

    // ───────────── OUTLINE / MISC ─────────────
    val outlineColors = listOf(
        ColorEdit(ColorSettingsStore.outlineColor, stringResource(R.string.outline_color), defaultColorScheme.outline),
        ColorEdit(ColorSettingsStore.outlineVariantColor, stringResource(R.string.outline_variant_color), defaultColorScheme.outlineVariant),
        ColorEdit(ColorSettingsStore.scrimColor, stringResource(R.string.scrim_color), defaultColorScheme.scrim)
    )
    val outlineSectionTitle = stringResource(R.string.outline_colors_section)

    // ───────────── SURFACE CONTAINERS ─────────────
    val surfaceContainerColors = listOf(
        ColorEdit(ColorSettingsStore.surfaceBrightColor, stringResource(R.string.surface_bright_color), defaultColorScheme.surfaceBright),
        ColorEdit(ColorSettingsStore.surfaceContainerColor, stringResource(R.string.surface_container_color), defaultColorScheme.surfaceContainer),
        ColorEdit(ColorSettingsStore.surfaceContainerHighColor, stringResource(R.string.surface_container_high_color), defaultColorScheme.surfaceContainerHigh),
        ColorEdit(ColorSettingsStore.surfaceContainerHighestColor, stringResource(R.string.surface_container_highest_color), defaultColorScheme.surfaceContainerHighest),
        ColorEdit(ColorSettingsStore.surfaceContainerLowColor, stringResource(R.string.surface_container_low_color), defaultColorScheme.surfaceContainerLow),
        ColorEdit(ColorSettingsStore.surfaceContainerLowestColor, stringResource(R.string.surface_container_lowest_color), defaultColorScheme.surfaceContainerLowest),
        ColorEdit(ColorSettingsStore.surfaceDimColor, stringResource(R.string.surface_dim_color), defaultColorScheme.surfaceDim)
    )
    val surfaceContainerSectionTitle = stringResource(R.string.surface_container_colors_section)

    // ───────────── PRIMARY / SECONDARY / TERTIARY FIXED ─────────────
    val fixedColors = listOf(
        ColorEdit(ColorSettingsStore.primaryFixedColor, stringResource(R.string.primary_fixed_color), defaultColorScheme.primaryFixed),
        ColorEdit(ColorSettingsStore.primaryFixedDimColor, stringResource(R.string.primary_fixed_dim_color), defaultColorScheme.primaryFixedDim),
        ColorEdit(ColorSettingsStore.onPrimaryFixedColor, stringResource(R.string.on_primary_fixed_color), defaultColorScheme.onPrimaryFixed),
        ColorEdit(ColorSettingsStore.onPrimaryFixedVariantColor, stringResource(R.string.on_primary_fixed_variant_color), defaultColorScheme.onPrimaryFixedVariant),
        ColorEdit(ColorSettingsStore.secondaryFixedColor, stringResource(R.string.secondary_fixed_color), defaultColorScheme.secondaryFixed),
        ColorEdit(ColorSettingsStore.secondaryFixedDimColor, stringResource(R.string.secondary_fixed_dim_color), defaultColorScheme.secondaryFixedDim),
        ColorEdit(ColorSettingsStore.onSecondaryFixedColor, stringResource(R.string.on_secondary_fixed_color), defaultColorScheme.onSecondaryFixed),
        ColorEdit(ColorSettingsStore.onSecondaryFixedVariantColor, stringResource(R.string.on_secondary_fixed_variant_color), defaultColorScheme.onSecondaryFixedVariant),
        ColorEdit(ColorSettingsStore.tertiaryFixedColor, stringResource(R.string.tertiary_fixed_color), defaultColorScheme.tertiaryFixed),
        ColorEdit(ColorSettingsStore.tertiaryFixedDimColor, stringResource(R.string.tertiary_fixed_dim_color), defaultColorScheme.tertiaryFixedDim),
        ColorEdit(ColorSettingsStore.onTertiaryFixedColor, stringResource(R.string.on_tertiary_fixed_color), defaultColorScheme.onTertiaryFixed),
        ColorEdit(ColorSettingsStore.onTertiaryFixedVariantColor, stringResource(R.string.on_tertiary_fixed_variant_color), defaultColorScheme.onTertiaryFixedVariant)
    )
    val fixedSectionTitle = stringResource(R.string.fixed_colors_section)


    val angleLineColor by ColorSettingsStore.angleLineColor.asStateNull()
    val circleColor by ColorSettingsStore.circleColor.asStateNull()

    val launchAppColor by ColorSettingsStore.launchAppColor.asStateNull()
    val openUrlColor by ColorSettingsStore.openUrlColor.asStateNull()
    val notificationShadeColor by ColorSettingsStore.notificationShadeColor.asStateNull()
    val controlPanelColor by ColorSettingsStore.controlPanelColor.asStateNull()
    val openAppDrawerColor by ColorSettingsStore.openAppDrawerColor.asStateNull()
    val launcherSettingsColor by ColorSettingsStore.launcherSettingsColor.asStateNull()
    val lockColor by ColorSettingsStore.lockColor.asStateNull()
    val openFileColor by ColorSettingsStore.openFileColor.asStateNull()
    val reloadColor by ColorSettingsStore.reloadColor.asStateNull()
    val openRecentAppsColor by ColorSettingsStore.openRecentAppsColor.asStateNull()
    val openCircleNest by ColorSettingsStore.openCircleNestColor.asStateNull()
    val goParentCircle by ColorSettingsStore.goParentNestColor.asStateNull()

    val selectedDefaultTheme by ColorModesSettingsStore.defaultTheme.flow(ctx).collectAsState(initial = DARK)


    var showResetValidation by remember { mutableStateOf(false) }

    var showBurgerMenu by remember { mutableStateOf(false) }

    var selectedCustomView by remember { mutableStateOf(CustomColorModeEditing.NORMAL) }

    var showRandomColorsValidation by remember { mutableStateOf(false) }
    var showAllColorsValidation by remember { mutableStateOf(false) }

    SettingsLazyHeader(
        title = stringResource(R.string.color_selector),
        onBack = onBack,
        helpText = stringResource(R.string.color_selector_text),
        onReset = {
            scope.launch {
                ColorSettingsStore.resetAll(ctx)
            }
        }
    ) {
        item {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .height(IntrinsicSize.Max)
                    .background(
                        color = MaterialTheme.colorScheme.surface,
                        shape = DragonShape
                    )
                    .padding(12.dp),
                horizontalArrangement = Arrangement.SpaceEvenly
            ) {
                DefaultThemes.entries.filter { it != AMOLED }.forEach {
                    val selected = it == defaultTheme

                    Column(
                        modifier = Modifier
                            .weight(1f)
                            .fillMaxHeight()
                            .clip(DragonShape)
                            .conditional(
                                condition = selected,
                                other = Modifier.background(MaterialTheme.colorScheme.surfaceDim)
                            )
                            .clickable {
                                scope.launch {
                                    ColorModesSettingsStore.defaultTheme.set(ctx, it)
                                }
                            }
                            .padding(5.dp),
                        horizontalAlignment = Alignment.CenterHorizontally
                    ) {

                        val background = when (it) {
                            AMOLED -> null

                            DARK   -> Color.DarkGray
                            LIGHT  -> Color.White
                            SYSTEM -> Brush.horizontalGradient(
                                colors = listOf(
                                    Color.White,
                                    Color.Black
                                )
                            )

                            CUSTOM -> Brush.linearGradient(
                                colors = listOf(
                                    Color.Red,
                                    Color.Yellow,
                                    Color.Green,
                                    Color.Cyan,
                                    Color.Blue,
                                    Color.Magenta
                                )
                            )
                        }


                        // I like this simple animation I made, I think I've changed my mind about animations
                        val shapeCorners by animateIntAsState(
                            targetValue = if (selected) 12 else 50,
                            animationSpec = tween(durationMillis = 300, easing = Ease),
                            label = "box_shape"
                        )

                        val boxShape = RoundedCornerShape(shapeCorners)

                        if (background != null) {
                            Box(
                                modifier = Modifier
                                    .size(40.dp)
                                    .clip(boxShape)
                                    .then(
                                        when (background) {
                                            is Color -> Modifier.background(background)
                                            is Brush -> Modifier.background(background)
                                            else -> Modifier
                                        }
                                    )
                                    .border(
                                        1.dp,
                                        MaterialTheme.colorScheme.outline.copy(alpha = 0.5f),
                                        boxShape
                                    )
                            )
                        }


                        Spacer(Modifier.height(5.dp))

                        Text(
                            text = defaultThemeName(it),
                            color = MaterialTheme.colorScheme.onSurface,
                            style = MaterialTheme.typography.labelSmall,
                            textAlign = TextAlign.Center
                        )
                    }
                }
            }
        }


        item { HorizontalDivider(color = MaterialTheme.colorScheme.outline) }

        if (defaultTheme == CUSTOM) {

            item {
                Row(
                    horizontalArrangement = Arrangement.spacedBy(10.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Button(
                        onClick = { showResetValidation = true },
                        modifier = Modifier.weight(1f),
                        colors = AppObjectsColors.buttonColors()
                    ) {
                        Icon(
                            imageVector = Icons.Default.Restore,
                            contentDescription = stringResource(R.string.reset),
                            tint = MaterialTheme.colorScheme.onPrimary,
                            modifier = Modifier
                                .clip(CircleShape)
                                .padding(5.dp)
                        )

                        Text(
                            text = stringResource(R.string.reset_to_default_colors),
                            color = MaterialTheme.colorScheme.onPrimary
                        )
                    }

                    Box {
                        IconButton(
                            onClick = { showBurgerMenu = true },
                            colors = AppObjectsColors.iconButtonColors(
                                backgroundColor = MaterialTheme.colorScheme.primary.copy(0.5f)
                            )
                        ) {
                            Icon(
                                imageVector = Icons.Default.MoreVert,
                                contentDescription = stringResource(R.string.open_burger_menu),
                                modifier = Modifier
                                    .clip(CircleShape)
                                    .padding(5.dp)
                            )
                        }

                        DropdownMenu(
                            expanded = showBurgerMenu,
                            onDismissRequest = { showBurgerMenu = false },
                            containerColor = Color.Transparent,
                            shadowElevation = 0.dp,
                            tonalElevation = 0.dp
                        ) {
                            BurgerListAction(
                                actions = listOf(
                                    BurgerAction(
                                        onClick = {
                                            showRandomColorsValidation = true
                                            showBurgerMenu = false
                                        }
                                    ) {
                                        Icon(Icons.Default.Shuffle, null)
                                        Text(stringResource(R.string.make_every_colors_random))
                                    },
                                    BurgerAction(
                                        onClick = {
                                            showAllColorsValidation = true
                                            showBurgerMenu = false
                                        }
                                    ) {
                                        Icon(Icons.Default.SelectAll, null)
                                        Text(stringResource(R.string.make_all_colors_identical))
                                    }
                                )
                            )
                        }
                    }
                }
            }

            item {
                ActionRow(
                    actions = CustomColorModeEditing.entries,
                    actionIcon = { customColorModeEditingIcon(it) },
                    actionName = { customColorModeEditingName(ctx, it) },
                    selectedView = selectedCustomView,
                ) { selectedCustomView = it }
            }

            if (selectedCustomView == CustomColorModeEditing.NORMAL) {
                colorsGroup(
                    colors = primaryColors,
                    sectionLabel = primarySectionTitle
                )
                colorsGroup(
                    colors = primaryColors,
                    sectionLabel = primarySectionTitle
                )
                colorsGroup(
                    colors = secondaryColors,
                    sectionLabel = secondarySectionTitle
                )
                colorsGroup(
                    colors = tertiaryColors,
                    sectionLabel = tertiarySectionTitle
                )
                colorsGroup(
                    colors = backgroundColors,
                    sectionLabel = backgroundSectionTitle
                )
                colorsGroup(
                    colors = errorColors,
                    sectionLabel = errorSectionTitle
                )
                colorsGroup(
                    colors = outlineColors,
                    sectionLabel = outlineSectionTitle
                )
                colorsGroup(
                    colors = surfaceContainerColors,
                    sectionLabel = surfaceContainerSectionTitle
                )
                colorsGroup(
                    colors = fixedColors,
                    sectionLabel = fixedSectionTitle
                )
            } else {

                // === Extra custom action colors ===
                item {
                    ColorPickerRow(
                        currentColor = angleLineColor ?: LocalExtraColors.current.angleLine,
                        label = stringResource(R.string.angle_line_color),
                    ) { scope.launch { ColorSettingsStore.angleLineColor.set(ctx, it) } }
                }

                item {
                    ColorPickerRow(
                        currentColor = circleColor ?: LocalExtraColors.current.circle,
                        label = stringResource(R.string.circle_color),
                    ) { scope.launch { ColorSettingsStore.circleColor.set(ctx, it) } }
                }

                item {
                    ColorPickerRow(
                        currentColor = launchAppColor ?: LocalExtraColors.current.launchApp,
                        label = stringResource(R.string.launch_app_color),
                    ) { scope.launch { ColorSettingsStore.launchAppColor.set(ctx, it) } }
                }

                item {
                    ColorPickerRow(
                        currentColor = openUrlColor ?: LocalExtraColors.current.openUrl,
                        label = stringResource(R.string.open_url_color),
                    ) { scope.launch { ColorSettingsStore.openUrlColor.set(ctx, it) } }
                }

                item {
                    ColorPickerRow(
                        currentColor = notificationShadeColor
                            ?: LocalExtraColors.current.notificationShade,
                        label = stringResource(R.string.notification_shade_color),
                    ) { scope.launch { ColorSettingsStore.notificationShadeColor.set(ctx, it) } }
                }

                item {
                    ColorPickerRow(
                        currentColor = controlPanelColor ?: LocalExtraColors.current.controlPanel,
                        label = stringResource(R.string.control_panel_color),
                    ) { scope.launch { ColorSettingsStore.controlPanelColor.set(ctx, it) } }
                }

                item {
                    ColorPickerRow(
                        currentColor = openAppDrawerColor ?: LocalExtraColors.current.openAppDrawer,
                        label = stringResource(R.string.open_app_drawer_color),
                    ) { scope.launch { ColorSettingsStore.openAppDrawerColor.set(ctx, it) } }
                }

                item {
                    ColorPickerRow(
                        currentColor = launcherSettingsColor
                            ?: LocalExtraColors.current.launcherSettings,
                        label = stringResource(R.string.launcher_settings_color),
                    ) { scope.launch { ColorSettingsStore.launcherSettingsColor.set(ctx, it) } }
                }

                item {
                    ColorPickerRow(
                        currentColor = lockColor ?: LocalExtraColors.current.lock,
                        label = stringResource(R.string.lock_color),
                    ) { scope.launch { ColorSettingsStore.lockColor.set(ctx, it) } }
                }

                item {
                    ColorPickerRow(
                        currentColor = openFileColor ?: LocalExtraColors.current.openFile,
                        label = stringResource(R.string.open_file_color),
                    ) { scope.launch { ColorSettingsStore.openFileColor.set(ctx, it) } }
                }

                item {
                    ColorPickerRow(
                        currentColor = reloadColor ?: LocalExtraColors.current.reload,
                        label = stringResource(R.string.reload_color),
                    ) { scope.launch { ColorSettingsStore.reloadColor.set(ctx, it) } }
                }
                item {
                    ColorPickerRow(
                        currentColor = openRecentAppsColor
                            ?: LocalExtraColors.current.openRecentApps,
                        label = stringResource(R.string.open_recent_apps_color),
                    ) { scope.launch { ColorSettingsStore.openRecentAppsColor.set(ctx, it) } }
                }
                item {
                    ColorPickerRow(
                        currentColor = openCircleNest ?: LocalExtraColors.current.openCircleNest,
                        label = stringResource(R.string.open_circle_nest_color),
                    ) { scope.launch { ColorSettingsStore.openCircleNestColor.set(ctx, it) } }
                }
                item {
                    ColorPickerRow(
                        currentColor = goParentCircle ?: LocalExtraColors.current.goParentNest,
                        label = stringResource(R.string.go_parent_nest_color),
                    ) { scope.launch { ColorSettingsStore.goParentNestColor.set(ctx, it) } }
                }
            }
        }


        if (selectedDefaultTheme == DARK || selectedDefaultTheme == AMOLED) {
            item {
                SwitchRow(
                    state = selectedDefaultTheme == AMOLED,
                    text = stringResource(R.string.amoled_theme),
                    subText = stringResource(R.string.use_pure_black_background)
                ) {
                    val theme = if (it) {
                        AMOLED
                    } else DARK

                    scope.launch {
                        ColorModesSettingsStore.defaultTheme.set(ctx, theme)
                    }
                }
            }
        }

        // Only show the dynamic colors switch when in SYSTEM view
        if (selectedDefaultTheme == SYSTEM) {
            item {
                SettingsSwitchRow(
                    setting = ColorModesSettingsStore.dynamicColor,
                    title = stringResource(R.string.dynamic_colors),
                    description = stringResource(R.string.dynamic_colors_desc)
                )
            }
        }
    }

    if (showResetValidation) {
        UserValidation(
            title = stringResource(R.string.reset_to_default_colors),
            message = stringResource(R.string.reset_to_default_colors_explanation),
            onCancel = { showResetValidation = false }
        ) {
            scope.launch {
                ColorSettingsStore.resetAll(ctx)
                showResetValidation = false
            }
        }
    }
    if (showRandomColorsValidation) {
        UserValidation(
            title = stringResource(R.string.make_every_colors_random),
            message = stringResource(R.string.make_every_colors_random_explanation),
            onCancel = { showRandomColorsValidation = false }
        ) {
            scope.launch {
                ColorSettingsStore.setAllRandomColors(ctx)
                showRandomColorsValidation = false
            }
        }
    }


    if (showAllColorsValidation) {
        var applyColor by remember { mutableStateOf(Color.Black) }
        AlertDialog(
            onDismissRequest = { showAllColorsValidation = false },
            confirmButton = {
                TextButton(
                    onClick = {
                        scope.launch {
                            ColorSettingsStore.setAllSameColors(ctx, applyColor)
                            showAllColorsValidation = false
                        }
                    },
                    modifier = Modifier
                        .fillMaxWidth()
                        .clip(CircleShape)
                        .padding(5.dp)
                ) {
                    Text(
                        text = stringResource(R.string.apply),
                        color = MaterialTheme.colorScheme.primary
                    )
                }
            },
            title = {
                ColorPickerRow(
                    currentColor = applyColor,
                    label = stringResource(R.string.color_mode_all),
                    backgroundColor = MaterialTheme.colorScheme.surface.adjustBrightness(0.7f)
                ) { applyColor = it ?: Color.Black }
            },
            containerColor = MaterialTheme.colorScheme.surface,
            shape = DragonShape
        )
    }
}

private data class ColorEdit(
    val setting: BaseSettingObject<Color, Int>,
    val label: String,
    val defaultColor: Color
)


private fun LazyListScope.colorsGroup(
    colors: List<ColorEdit>,
    sectionLabel: String,
    examples: @Composable (ColumnScope.() -> Unit)? = null
) {
    item {

        Column(
            modifier = Modifier
                .fillMaxWidth()
                .clip(DragonShape)
                .background(MaterialTheme.colorScheme.surfaceVariant)
                .border(1.dp, MaterialTheme.colorScheme.primary, DragonShape)
                .padding(5.dp),
            verticalArrangement = Arrangement.spacedBy(5.dp)
        ) {

            Text(
                text = sectionLabel,
                style = MaterialTheme.typography.titleMedium,
                modifier = Modifier.padding(bottom = 5.dp)
            )

            examples?.let { it() }


            colors.forEach {
                SettingsColorPicker(
                    settingObject = it.setting,
                    defaultColor = it.defaultColor,
                    label = it.label
                )
            }
        }
    }
}
